<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
  <title></title>
	    
  <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
  	integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  	  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  	  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  	  crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.0/paper-full.min.js"></script>
  
  <script src="https://code.jquery.com/pep/0.4.1/pep.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paste.js/0.0.21/paste.min.js"></script>

  <!-- <script crossorigin="anonymous" src="/static/jquery-3.3.1.min.js"></script> -->
  <!-- <link crossorigin="anonymous" href="/static/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <link crossorigin="anonymous" href="/static/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"> -->
  <!-- <script crossorigin="anonymous" src="/static/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script> -->
  <!-- <script crossorigin="anonymous" src="/static/bootstrap/4.0.0/js/bootstrap.min.js"></script> -->
  <!-- <script src="/static/ajax/libs/paper.js/0.12.0/paper-full.min.js"></script> -->
  <!-- <script src="./three.min.js"></script> -->
  <!-- <script src="/static/pep/0.4.1/pep.js"></script>   -->
  <!-- <script src="/static/dexie@latest/dist/dexie.js"></script> -->
    
  <script src="/static/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"></script>  
  
  <script src="./three.min.js"></script>
  <script src="./OBJLoader.js"></script>
  <script src="./OrbitControls.js"></script>
  <script src="./QuickHull.js"></script>    
  <script src="./ConvexGeometry.js"></script>
  <script src="./SimplifyModifier.js"></script>
  <script src="./SubdivisionModifier.js"></script>
  <script type="module" src="./three.CSGMesh.js"></script>

  <script src="./ThreeCSG.js"></script>

  <script src="./libs.build.nopaper.js"></script>
  <script src="./libs.paper.min.js"></script>
  
  <script src="./svg.catmullRom.js"></script>
  <script src="./app.js"></script>
  <script src="./app.three.js"></script>
  <script src="./app.two.js"></script>

  <link href="https://fonts.googleapis.com/css?family=B612" rel="stylesheet">
  <style>
    body { font-family: 'B612', sans-serif; }
    #canvas { border: thin solid grey }
    #sidemenu img { display: block; width: 40; height: 40; padding: 2; margin: 2 }
    #sidemenu img.active { border: thin solid grey;  border-radius: 6px; background-color: #DCDCDC }
    .btn { margin:3px }
  </style>
</head>

<body>
  <div id="topmenu">
  </div>
  <div class="container-fluid" style="padding-top:70px">
    <div class="row" >
      <div class="col-12">
	<div style="height:80vh;width:4vw;display:inline-block" id="sidemenu">
	  <img class="mode" data-command="3d view" src="./icons/3d-move.svg">	
	  <img class="mode" data-command="select" src="./icons/select.svg">
	  <img class="mode" data-command="freehand" src="./icons/draw-freehand.svg">
	  <img class="mode" data-command="splines" src="./icons/draw-splines.svg">
	  <img class="mode" data-command="straight lines" src="./icons/draw-polylines.svg">

	  <img class="mode" data-command="edit splines" src="./icons/edit-nodes.svg">
	  <img class="mode" data-command="edit splines zoom" src="./icons/edit-nodes-zoom.svg">	
	  <img class="mode" data-command="get handles" src="./icons/get-handles.svg">	
	  <img class="mode" data-command="straight lines" src="./icons/cross-sections.svg">	
	  <img data-command="zoom to fit" src="./icons/zoom-fit-selection.svg">
	</div>
	<div style="height:80vh;width:76vw;position:relative;display:inline-block">
	  <div class="" id="webGL" style="width:100%;height:80vh;position: absolute; padding:0;margin:0">
	    <canvas style="width:100%;height:80vh;position: absolute; padding:0;margin:0;display:none"></canvas>
	  </div>
	  <div class="" id="canvas" style="width:100%;height:80vh;position: absolute; padding:0;margin:0">
	    <canvas style="width:100%;height:80vh;position: absolute; padding:0;margin:0;display:none"></canvas>
	  </div>
	</div>
	<div id="cards" style="font-size:80%;height:80vh;width:17vw;position:absolute;top:0;display:inline-block;margin-left:6px">
	</div>
      </div>
    </div>
    <div class="row">
      <div class="col-2 offset-1"><pre id="bbox_min">bbox</pre></div>
      <div class="col-2"><pre id="bbox_max">bbox</pre></div>
      <div class="col-2"><pre id="bbox_center">bbox</pre></div>
    </div>
  </div>
  <script>
    var app;
    var offScreenOn = ('OffscreenCanvas' in window)

    var intersectionWorker = (new Worker( './intersectionWorker.js' ));
    $(function(){
	var loader = new THREE.ObjectLoader();
	var webGL = document.querySelector('canvas')
	app = new App(webGL, document.getElementById('canvas'), { width: 120, height: 120 });

	var axesHelper = new THREE.AxesHelper( 20 );
	app.three.scene.add( axesHelper );
	
	intersectionWorker.onmessage = function(e) {
	    console.log(e.data.id);
	    var intersects = e.data.points.filter(e => {
		return e.length
	    }).map(e => {
		var p = e[0].point
		return new THREE.Vector3( p.x, p.y, p.z );
	    })
	    app.three.makeExtrusionFromPointsPromise(intersects, e.data.length, e.data.svg, e.data.camera)
		.then(r => { document.getElementById(e.data.id).remove() })
		.catch(e => { console.log(e); })
	}
	var animate = app.three.animate;


	function onMouseMove( e ) {
	    console.log(e);
	    if(e.which != 0) return;
	    mouse.x = e.clientX;
	    mouse.y = e.clientY;
	    var raymouse = new THREE.Vector2();
	    raymouse.x = ( e.clientX / window.innerWidth ) * 2 - 1;
	    raymouse.y = - ( e.clientY / window.innerHeight ) * 2 + 1;
	    raycaster.setFromCamera( raymouse, camera );
	    var intersect;
	    intersect = gpuPicker.pick(mouse, raycaster);

	    console.log(intersect);
	}

	
	var frustumSize = 1000;
	app.three.camera = new THREE.OrthographicCamera(
	    frustumSize * app.three.aspect / - 2,
	    frustumSize * app.three.aspect / 2,
	    frustumSize / 2,
	    frustumSize / - 2,
	    -32000,
	     32000
	);

	app.three.camera.position.set( 100, 100, 100 );
	// app.three.scene.add(app.three.camera);


	app.three.scene.background = new THREE.Color( 0xdddddd );
	app.db.objects.get('obj')
	    .then(e => {
		var loader = new THREE.ObjectLoader();
		var object = loader.parse( e.obj, function(e) {
		    console.log('loaded');
		    app.three.scene.add(e);
		    app.three.mesh = e;
		    app.three.zoomToFit();
		    app.three.scene.updateMatrixWorld();
		    app.three.mesh.traverse(function(child) {
			if (child instanceof THREE.Mesh) {
			    var geometry = new THREE.Geometry();
			    geometry.fromBufferGeometry(child.geometry);
			    geometry.vertices.forEach((e, i) => {
		    		e.y = e.y * 1;
			    })
			    child.geometry.fromGeometry(geometry);
			} });
		    
		    intersectionWorker.postMessage({
			action: 'init',
			scene: app.three.scene.clone().toJSON(),
		    })
		} );
	    })
	    .catch(e => {
		console.log(e); 
	    })
	
	app.three.controls = new THREE.OrbitControls( app.three.camera, document.getElementById('canvas') );

	var ref = app.two.unproject(new THREE.Vector3(0, 0, 0));

	console.log(app.three.element);
	app.three.controls.addEventListener( 'change', function(e) {
	    app.three.camera.updateMatrixWorld()
	    var curr = app.two.unproject(new THREE.Vector3(0, 0, 0))
	    var dist = curr.clone().sub(ref)
	    app.two.zoomAtPoint(app.three.camera.zoom / app.three.zoomBase, curr);
	    app.two.panBy(dist)
	    ref = curr;
	} );

	app.three.addShadowedLight( 1,   1,  1, 0xffffff, 1 );
	app.three.addShadowedLight( -1,  1, -1, 0xffffff, 1 );
	app.three.addShadowedLight( 0,  -1, -1, 0xffffff, 1 );

	
	app.three.animate()
    })
  </script>
  <script src="./ui.js"></script>
  <script src="./getTopProfile.js"></script>
  <script src="./listParts.js"></script>
</body>
</html>
